import React, { useState, useEffect } from 'react';
import { Mic, Music, Star, Zap, Trophy, Sword, Users, RefreshCw, Skull, Hand } from 'lucide-react';

// Lustige Attribute für die Künstler
const ATTRIBUTES = [
  { id: 'vocals', label: 'Stimme', icon: Mic, color: 'text-blue-400' },
  { id: 'flow', label: 'Flow', icon: Music, color: 'text-green-400' },
  { id: 'presence', label: 'Bühnen-Präsenz', icon: Star, color: 'text-yellow-400' },
  { id: 'vibe', label: 'Vibe', icon: Zap, color: 'text-purple-400' },
  { id: 'lyrics', label: 'Texte', icon: Users, color: 'text-pink-400' },
];

const Card = ({ artist, hidden, onClick, interactive, winner, isTurn }) => {
  if (!artist) return <div className="w-64 h-96 bg-gray-800 rounded-xl animate-pulse"></div>;

  return (
    <div 
      className={`
        relative w-full max-w-xs h-96 rounded-xl border-4 transition-all duration-500 transform
        ${winner === true ? 'border-green-500 scale-105 shadow-[0_0_30px_rgba(34,197,94,0.6)]' : ''}
        ${winner === false ? 'border-red-500 opacity-50 grayscale' : ''}
        ${winner === null && isTurn ? 'border-yellow-400 shadow-[0_0_20px_rgba(250,204,21,0.4)] scale-[1.02]' : 'border-gray-700'}
        bg-slate-900 flex flex-col overflow-hidden
      `}
    >
      {/* Turn Indicator Badge */}
      {isTurn && winner === null && (
        <div className="absolute top-0 inset-x-0 bg-yellow-400 text-slate-900 text-xs font-black text-center py-1 z-20 uppercase tracking-widest animate-pulse">
          Wähle einen Stat!
        </div>
      )}

      {/* Header Image / Avatar Placeholder */}
      <div className={`h-32 w-full ${artist.color} flex items-center justify-center relative`}>
        <span className="text-6xl font-black text-white opacity-20">{artist.name.charAt(0)}</span>
        <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-slate-900 to-transparent"></div>
      </div>

      {/* Content */}
      <div className="p-4 flex-1 flex flex-col">
        <h3 className="text-2xl font-bold text-white mb-1 truncate">{artist.name}</h3>
        <p className="text-gray-400 text-xs uppercase tracking-widest mb-4">Fighter Level {Math.floor(artist.totalPower / 10)}</p>

        {hidden ? (
          <div className="flex-1 flex items-center justify-center flex-col gap-2 animate-in fade-in duration-300">
             <div className="w-16 h-16 rounded-full bg-gray-800/80 border border-gray-700 flex items-center justify-center">
                <span className="text-3xl opacity-50">?</span>
             </div>
             <p className="text-gray-500 text-sm">Wartet auf Angriff...</p>
          </div>
        ) : (
          <div className="space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-300">
            {ATTRIBUTES.map((attr) => (
              <button
                key={attr.id}
                disabled={!interactive}
                onClick={() => interactive && onClick(attr.id)}
                className={`
                  w-full flex items-center justify-between p-2 rounded-lg transition-all
                  ${interactive 
                    ? 'hover:bg-gray-800 cursor-pointer ring-1 ring-gray-700 hover:ring-yellow-400 hover:scale-[1.02] active:scale-95' 
                    : 'cursor-default opacity-80'}
                  ${interactive ? 'group' : ''}
                `}
              >
                <div className="flex items-center gap-2">
                  <attr.icon size={16} className={`${attr.color} transition-transform group-hover:scale-110`} />
                  <span className="text-sm text-gray-300 group-hover:text-white">{attr.label}</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-24 h-2 bg-gray-800 rounded-full overflow-hidden">
                    <div 
                      className={`h-full ${attr.color.replace('text', 'bg')}`} 
                      style={{ width: `${artist.stats[attr.id]}%` }}
                    ></div>
                  </div>
                  <span className="text-sm font-bold text-white w-6 text-right">{artist.stats[attr.id]}</span>
                </div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default function App() {
  const [phase, setPhase] = useState('setup'); // setup, battle, round-end, game-over
  const [teamMe, setTeamMe] = useState([]);
  const [teamGF, setTeamGF] = useState([]);
  const [currentRound, setCurrentRound] = useState(0);
  const [scores, setScores] = useState({ me: 0, gf: 0 });
  const [battleLog, setBattleLog] = useState("Bereit für das Battle...");
  const [roundWinner, setRoundWinner] = useState(null); // 'me', 'gf', or 'draw'

  // Eingabe-Status
  const [inputMe, setInputMe] = useState("");
  const [inputGF, setInputGF] = useState("");

  // Runden-Logik: Gerade Runden (0, 2, 4...) -> Ich bin dran. Ungerade -> Sie ist dran.
  const isMyTurn = currentRound % 2 === 0;

  // Hilfsfunktion: Zufällige Stats generieren
  const generateArtist = (name, colorClass) => {
    const stats = {};
    let totalPower = 0;
    ATTRIBUTES.forEach(attr => {
      const val = Math.floor(Math.random() * 60) + 40; // Werte zwischen 40 und 100
      stats[attr.id] = val;
      totalPower += val;
    });
    return { name, stats, totalPower, color: colorClass };
  };

  const handleAddMe = () => {
    if (inputMe.trim() && teamMe.length < 10) {
      setTeamMe([...teamMe, generateArtist(inputMe, 'bg-cyan-600')]);
      setInputMe("");
    }
  };

  const handleAddGF = () => {
    if (inputGF.trim() && teamGF.length < 10) {
      setTeamGF([...teamGF, generateArtist(inputGF, 'bg-fuchsia-600')]);
      setInputGF("");
    }
  };

  const loadDemoData = () => {
    const demoMe = ["Kanye West", "The Weeknd", "Daft Punk", "Kendrick Lamar", "Tame Impala", "Gorillaz", "Frank Ocean", "Drake", "Eminem", "Travis Scott"];
    const demoGF = ["Taylor Swift", "Harry Styles", "Dua Lipa", "Adele", "Beyoncé", "Billie Eilish", "Lana Del Rey", "Rihanna", "Ariana Grande", "Olivia Rodrigo"];
    
    setTeamMe(demoMe.map(n => generateArtist(n, 'bg-cyan-600')));
    setTeamGF(demoGF.map(n => generateArtist(n, 'bg-fuchsia-600')));
  };

  const startBattle = () => {
    if (teamMe.length === 10 && teamGF.length === 10) {
      setPhase('battle');
      setBattleLog("Runde 1: Du beginnst! Wähle einen Stat.");
    }
  };

  const playRound = (statId) => {
    const valMe = teamMe[currentRound].stats[statId];
    const valGF = teamGF[currentRound].stats[statId];
    const statLabel = ATTRIBUTES.find(a => a.id === statId).label;
    
    // Kurze Verzögerung für Spannung
    setPhase('resolving'); 

    setTimeout(() => {
      if (valMe > valGF) {
        setScores(s => ({ ...s, me: s.me + 1 }));
        setBattleLog(`${teamMe[currentRound].name} gewinnt mit ${statLabel} (${valMe} vs ${valGF})!`);
        setRoundWinner('me');
      } else if (valGF > valMe) {
        setScores(s => ({ ...s, gf: s.gf + 1 }));
        setBattleLog(`${teamGF[currentRound].name} kontert mit ${statLabel} (${valGF} vs ${valMe})!`);
        setRoundWinner('gf');
      } else {
        setBattleLog(`Unentschieden bei ${statLabel} (${valMe})!`);
        setRoundWinner('draw');
      }
      setPhase('round-end');
    }, 400);
  };

  const nextRound = () => {
    if (currentRound < 9) {
      setCurrentRound(curr => curr + 1);
      setPhase('battle');
      setRoundWinner(null);
      
      // Update Log for next turn
      const nextIsMyTurn = (currentRound + 1) % 2 === 0;
      setBattleLog(nextIsMyTurn ? "Du bist am Zug!" : "Sie ist am Zug! Mach dich bereit.");
      
    } else {
      setPhase('game-over');
    }
  };

  // --- UI COMPONENTS ---

  if (phase === 'setup') {
    return (
      <div className="min-h-screen bg-slate-950 text-white font-sans selection:bg-purple-500">
        <div className="max-w-4xl mx-auto p-6">
          <header className="text-center mb-12">
            <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 mb-4 tracking-tighter">
              BEAT BATTLE
            </h1>
            <p className="text-gray-400">Das ultimative Musik-Duell. Wer hat den besseren Geschmack?</p>
          </header>

          <div className="grid md:grid-cols-2 gap-12">
            {/* Player Me */}
            <div className="bg-slate-900/50 p-6 rounded-2xl border border-cyan-900/50">
              <h2 className="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                <Sword size={20} /> Dein Team
              </h2>
              <div className="flex gap-2 mb-4">
                <input 
                  value={inputMe}
                  onChange={(e) => setInputMe(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleAddMe()}
                  placeholder="Künstler Name..."
                  className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-cyan-500 transition"
                />
                <button onClick={handleAddMe} className="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded-lg font-bold">+</button>
              </div>
              <ul className="space-y-2 mb-4">
                {teamMe.map((a, i) => (
                  <li key={i} className="bg-slate-800 px-3 py-2 rounded flex justify-between items-center animate-in fade-in slide-in-from-left-4">
                    <span>{a.name}</span>
                    <span className="text-xs text-cyan-500 font-mono">{a.totalPower} PWR</span>
                  </li>
                ))}
                {teamMe.length === 0 && <li className="text-slate-600 italic text-center py-4">Noch keine Kämpfer</li>}
              </ul>
              <div className="text-right text-sm text-gray-500">{teamMe.length} / 10</div>
            </div>

            {/* Player GF */}
            <div className="bg-slate-900/50 p-6 rounded-2xl border border-fuchsia-900/50">
              <h2 className="text-xl font-bold text-fuchsia-400 mb-4 flex items-center gap-2">
                <Star size={20} /> Team Freundin
              </h2>
              <div className="flex gap-2 mb-4">
                <input 
                  value={inputGF}
                  onChange={(e) => setInputGF(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleAddGF()}
                  placeholder="Künstler Name..."
                  className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-fuchsia-500 transition"
                />
                <button onClick={handleAddGF} className="bg-fuchsia-600 hover:bg-fuchsia-500 px-4 py-2 rounded-lg font-bold">+</button>
              </div>
              <ul className="space-y-2 mb-4">
                {teamGF.map((a, i) => (
                  <li key={i} className="bg-slate-800 px-3 py-2 rounded flex justify-between items-center animate-in fade-in slide-in-from-right-4">
                    <span>{a.name}</span>
                    <span className="text-xs text-fuchsia-500 font-mono">{a.totalPower} PWR</span>
                  </li>
                ))}
                {teamGF.length === 0 && <li className="text-slate-600 italic text-center py-4">Noch keine Kämpfer</li>}
              </ul>
              <div className="text-right text-sm text-gray-500">{teamGF.length} / 10</div>
            </div>
          </div>

          <div className="mt-12 flex flex-col items-center gap-4">
            <button 
              onClick={startBattle}
              disabled={teamMe.length !== 10 || teamGF.length !== 10}
              className="bg-gradient-to-r from-cyan-600 to-purple-600 hover:from-cyan-500 hover:to-purple-500 disabled:opacity-30 disabled:cursor-not-allowed text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg shadow-purple-900/50 transition-all transform hover:scale-105"
            >
              BATTLE STARTEN
            </button>
            <button onClick={loadDemoData} className="text-slate-500 hover:text-white text-sm underline">
              Demo-Daten laden (Schnellstart)
            </button>
          </div>
        </div>
      </div>
    );
  }

  // --- BATTLE SCREEN ---
  
  return (
    <div className="min-h-screen bg-slate-950 text-white font-sans flex flex-col items-center justify-center p-4">
      {/* Scoreboard */}
      <div className="absolute top-0 w-full p-4 flex justify-between items-end max-w-4xl border-b border-slate-800 bg-slate-900/80 backdrop-blur-md z-10">
        <div className={`text-left transition-opacity duration-300 ${isMyTurn && phase === 'battle' ? 'opacity-100' : 'opacity-50'}`}>
          <div className="text-cyan-400 font-bold uppercase text-sm tracking-wider flex items-center gap-2">
            Dein Team {isMyTurn && phase === 'battle' && <span className="flex w-2 h-2 bg-cyan-400 rounded-full animate-ping"></span>}
          </div>
          <div className="text-4xl font-black">{scores.me}</div>
        </div>
        
        <div className="flex flex-col items-center">
           <div className="text-xl font-bold text-white bg-slate-800 px-4 py-1 rounded-full mb-2 border border-slate-700">
              Runde {currentRound + 1} / 10
           </div>
           <p className="text-gray-400 text-sm animate-pulse text-center max-w-md">{battleLog}</p>
        </div>

        <div className={`text-right transition-opacity duration-300 ${!isMyTurn && phase === 'battle' ? 'opacity-100' : 'opacity-50'}`}>
          <div className="text-fuchsia-400 font-bold uppercase text-sm tracking-wider flex items-center justify-end gap-2">
             {!isMyTurn && phase === 'battle' && <span className="flex w-2 h-2 bg-fuchsia-400 rounded-full animate-ping"></span>} Team Freundin
          </div>
          <div className="text-4xl font-black">{scores.gf}</div>
        </div>
      </div>

      {phase === 'game-over' ? (
        <div className="text-center animate-in zoom-in duration-500">
          <Trophy size={80} className="mx-auto text-yellow-400 mb-6" />
          <h2 className="text-5xl font-black mb-4">
            {scores.me > scores.gf ? "DU HAST GEWONNEN!" : scores.gf > scores.me ? "SIE HAT GEWONNEN!" : "UNENTSCHIEDEN!"}
          </h2>
          <p className="text-2xl text-gray-400 mb-8">
            Endstand: <span className="text-cyan-400">{scores.me}</span> - <span className="text-fuchsia-400">{scores.gf}</span>
          </p>
          <button 
            onClick={() => window.location.reload()} 
            className="flex items-center gap-2 mx-auto bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-xl font-bold transition"
          >
            <RefreshCw size={20} /> Neues Battle
          </button>
        </div>
      ) : (
        <div className="w-full max-w-5xl flex flex-col md:flex-row items-center justify-center gap-8 md:gap-20 mt-20">
          
          {/* My Card */}
          <div className="relative group transition-all duration-500">
            <div className={`absolute -top-12 left-0 right-0 text-center text-cyan-400 font-bold transition-opacity ${roundWinner === 'me' ? 'opacity-100' : 'opacity-0'}`}>
               WINNER
            </div>
            <Card 
              artist={teamMe[currentRound]} 
              interactive={phase === 'battle' && isMyTurn} 
              hidden={phase === 'battle' && !isMyTurn} // Verstecken, wenn ich NICHT dran bin
              isTurn={phase === 'battle' && isMyTurn}
              onClick={playRound}
              winner={phase === 'round-end' ? (roundWinner === 'me' ? true : roundWinner === 'draw' ? null : false) : null}
            />
          </div>

          {/* VS Element */}
          <div className="flex flex-col items-center gap-4">
             <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center border-4 border-slate-700 shadow-xl z-20">
               <span className="text-xl font-black italic text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 to-fuchsia-500">VS</span>
             </div>
             {phase === 'round-end' && (
               <button 
                 onClick={nextRound}
                 className="mt-4 bg-white text-slate-900 hover:bg-gray-200 font-bold px-8 py-3 rounded-full shadow-lg hover:shadow-xl transition-all animate-bounce"
               >
                 Nächste Runde &rarr;
               </button>
             )}
          </div>

          {/* GF Card */}
          <div className="relative">
             <div className={`absolute -top-12 left-0 right-0 text-center text-fuchsia-400 font-bold transition-opacity ${roundWinner === 'gf' ? 'opacity-100' : 'opacity-0'}`}>
               WINNER
            </div>
            <Card 
              artist={teamGF[currentRound]} 
              interactive={phase === 'battle' && !isMyTurn}
              hidden={phase === 'battle' && isMyTurn} // Verstecken, wenn ich dran bin
              isTurn={phase === 'battle' && !isMyTurn}
              onClick={playRound}
              winner={phase === 'round-end' ? (roundWinner === 'gf' ? true : roundWinner === 'draw' ? null : false) : null}
            />
          </div>

        </div>
      )}
    </div>
  );
}
